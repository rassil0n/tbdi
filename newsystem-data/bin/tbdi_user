#!/bin/sh

USERNAME=$1

create_user(){
cat << EOF
	Create user ${USERNAME}
	-----------------------
EOF
	useradd -m -G users -s /bin/zsh $USERNAME
	for group in sudo audio video;do
		gpasswd -a $USERNAME $group
	done
cat << EOF

	Set Password for ${USERNAME}
	----------------------------
EOF
	passwd $USERNAME
}

config_mpd(){
	gpasswd -a mpd users
	gpasswd -a mpd audio
}

create_folders(){
	su $USERNAME -c 'mkdir -p $HOME/{dl,temp,work,mm}'
	su $USERNAME -c 'mkdir -p $HOME/mnt/cell{1,2}'
	su $USERNAME -c 'mkdir -p $HOME/.local/{share,bin,repos,opt}'
}

install_configs(){
	clear
cat << EOF

	Setting up the configs
	----------------------

EOF
	su $USERNAME -c 'cd $HOME/.local/repos && git clone https://github.com/rassil0n/dots'
	su $USERNAME -c 'rsync -r $HOME/.local/repos/dots/ $HOME'
	su $USERNAME -c 'sh $HOME/.local/bin/setwal'
}

setup_crontab(){
cat << EOF
	Setup crontab for ${USERNAME}
	-----------------------------
EOF

cat >> /home/${USERNAME}/.config/cronjobs << EOF
SHELL=/bin/sh
0 * * * *       /home/${USERNAME}/.local/bin/cron/rsscheck > /dev/null
0 */4 * * *     /home/${USERNAME}/.local/bin/cron/updatecheck 2> /dev/null
0 */4 * * *     /home/${USERNAME}/.local/bin/cron/weathercheck 2> /dev/null
*/30 * * * *    /home/${USERNAME}/.local/bin/cron/batcheck 2> /dev/null
EOF

crontab - < /home/${USERNAME}/.config/cronjobs
}

setup_sshkey(){
cat << EOF
	Setup SSH-Key for ${USERNAME}
	-----------------------------
EOF

echo -n "Please enter your email: "
read USERMAIL
su $USERNAME -c 'ssh-keygen -t ed25519 -C ""$USERMAIL""'
}

init_doas(){
cat >> /usr/local/etc/doas.conf << EOF
permit keepenv $USERNAME as root
EOF
}

main(){
	create_user
	config_mpd
	create_folders
	install_configs
	setup_crontab
	setup_sshkey
	init_doas
}

main ${@}
